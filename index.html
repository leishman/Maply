<!-- The map and zoom and click functionality was created by Mike Bostock. (http://bl.ocks.org/mbostock/2206590)

I've simply built off of his great work. Please send suggestions to leishman3@gmail.com

Alexander Leishman
8/29/2013
-->

<!DOCTYPE html>
<meta charset="utf-8">
<style>


.lead {
  text-align: center;
  margin: 0;
}
.background {
  fill: #A0C3FF;
  pointer-events: all;
}

#states {
  fill: #DCDCDC;
}

#states .active {
  fill: #1874CD; /* originally 'orange' */
}

#state-borders {
  fill: none;
  stroke: #fff;
  stroke-width: 1.5px;
  stroke-linejoin: round;
  stroke-linecap: round;
  pointer-events: none;
}

div.tooltip {   
  position: absolute;           
  text-align: center;           
  width: 70px;                  
  height: 28px;                 
  padding: 2px;             
  font: 12px sans-serif;        
  background: none;   
  border: 0px;      
  border-radius: 0px;           
  pointer-events: none;         
}

body .modal {
  width: 1000px; /* SET THE WIDTH OF THE MODAL */
  margin: 0px 0 0 -450px; /* CHANGE MARGINS TO ACCOMODATE THE NEW WIDTH (original = margin: -250px 0 0 -280px;) */
}
.modal-body{
  height: 700px;
  margin-bottom: 0;
}

iframe {
  height: 600px;
  margin-bottom: 0;
}

svg {
  margin-left: auto;
  margin-right: auto;
  margin-top: 0;
  display: block;
  width: 1100;
}

.footer {
  margin-top: 10px;
  text-align: center;
}


</style>
<body>
<link href="css/bootstrap.min.css" rel="stylesheet">
<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<script src="js/bootstrap.js"></script>  
<script src = "../d3/d3.v3.js"></script>
<!-- <script src="../d3/"></script> -->
<!-- <script src="http://d3js.org/d3.v3.min.js"></script> -->
<script src="../d3/topojson.v1.min.js"></script>



<div class="page-header" style="margin:0"> 
  <h1>&nbsp;&nbsp;Maply v0.1 <small>by <a href="http://www.github.com">Alexander Leishman</a></small></h1>
</div>
<h5 class="lead" style="margin-bottom:3px">Click a state, any state.</h5>



<script>

var width = 1100,
    height = 620,
    centered;

var projection = d3.geo.albersUsa()
    .scale(1300)
    .translate([width / 2, height / 2]);


var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", clicked);

var g = svg.append("g");

d3.json("us.json", function(error, us) {
  g.append("g")
      .attr("id", "states")
    .selectAll("path")
      .data(topojson.feature(us, us.objects.states).features)
    .enter().append("path")
      .attr("d", path)
      // BEGIN ON MOUSEOVER
      .on("mouseover", function(d){
        if(!centered) { 
        d3.select(this).style("fill", "aliceblue");
        }

        // Make opacity zero if map is zoomed in
          div.transition()
            .duration(0)
            .style("opacity", function (d) {
              if(centered) {  
                return 0;
              }
              else{
                return 0.9;
              }
            });

          div .html(stateName(d.id))  // Need to find better way for positioning state names
            .style("left", (path.centroid(d)[0]+25) + "px")     
            .style("top", (path.centroid(d)[1]+90) + "px"); 
          })
      // END ON MOUSEOVER
      // BEGIN ON MOUSOUT
      .on("mouseout", function(d){
        if(!centered){
        d3.select(this).style("fill", "#DCDCDC");
        }
        div.transition()
          .duration(0)
          .style("opacity",0);
        })
      .on("click", function(d) {
        d3.select(this).style("fill", "#1874CD");
        clicked(d);
      });
      // END ON MOUSOUT
      
// Create State Borders
g.append("path")
    .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
    .attr("id", "state-borders")
    .attr("d", path);

  // CODE TO SHOW ALL STATE LABELS
  // g.selectAll("text")
  //   .data(topojson.feature(us, us.objects.states).features)
  //   .enter()
  //   .append("svg:text")
  //   .text(function(d){return stateName(d.id);})
  //     .attr("x", function(d){
  //       return path.centroid(d)[0];
  //   })
  //   .attr("y", function(d){
  //       return  path.centroid(d)[1];
  //   })
  //   .attr("text-anchor","middle")
  //   .attr('font-size','6pt')
  //   .attr("class","state-name");
});


// Function to look up ANSI state ID from JSON and find actual state name (yes I know it's ugly, future refactor)

function stateName(id) {

  states = [["Alabama",1],
    ["Alaska",2],
    ["Arizona",4],
    ["Arkansas",5],
    ["California",6],
    ["Colorado",8],
    ["Connecticut",9],
    ["Delaware",10],
    ["District of Columbia",11],
    ["Florida",12],
    ["Georgia",13],
    ["Hawaii",15],
    ["Idaho",16],
    ["Illinois",17],
    ["Indiana",18],
    ["Iowa",19],
    ["Kansas",20],
    ["Kentucky",21],
    ["Louisiana",22],
    ["Maine",23],
    ["Maryland",24],
    ["Massachusetts",25],
    ["Michigan",26],
    ["Minnesota",27],
    ["Mississippi",28],
    ["Missouri",29],
    ["Montana",30],
    ["Nebraska",31],
    ["Nevada",32],
    ["New Hampshire",33],
    ["New Jersey",34],
    ["New Mexico",35],
    ["New York",36],
    ["North Carolina",37],
    ["North Dakota",38],
    ["Ohio",39],
    ["Oklahoma",40],
    ["Oregon",41],
    ["Pennsylvania",42],
    ["Rhode Island",44],
    ["South Carolina",45],
    ["South Dakota",46],
    ["Tennessee",47],
    ["Texas",48],
    ["Utah",49],
    ["Vermont",50],
    ["Virginia",51],
    ["Washington",53],
    ["West Virginia",54],
    ["Wisconsin",55],
    ["Wyoming",56]];

  for (var i = 0; i < states.length; i++) {
    if (id == states[i][1]) {
      return states[i][0];
    }
  }
}
// END stateName()

// Executed when a state is clicked
function clicked(d) {
  var x, y, k;

  if (d && centered !== d) {
   zoomIn(d);

  } 
  else {
    zoomOut(d);
  }



  if (centered){
      // Create variable for state name string if not centered
      state = stateName(d.id);

      $("h4").text("Tryna learn about " + state + "? Check this out:");
      if (state == "Georgia") {
        pageSource = "http://en.wikipedia.org/wiki/Georgia_(U.S._state)"
      }
      else{
      pageSource = "http://www.wikipedia.org/wiki/" + state;
      }
      $("iframe").attr("src", pageSource)
      $("#myModal").modal();
      
      console.log(state);  
  }
}
// End clicked

function zoomOut() {

  x = width / 2;
  y = height / 2;
  k = 1;
  centered = null;

  // g.selectAll("path")
  //   .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");

}

function zoomIn(d) {

    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;

  
    
  g.selectAll("path")
    .classed("active", centered && function(d) { return d === centered; });

  g.transition()
      .duration(750)
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");



}




</script>
<body>
  <!-- Modal -->
  <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
      <h3 id="myModalLabel">State Information</h3>
    </div>
    <div class="modal-body">
      <h4>replace</h4>
      <iframe src="" style="zoom:0.60" width="100%" height="400" frameborder="0"></iframe>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-primary" id="close" data-dismiss="modal" aria-hidden="true">Close</button>
    </div>
  </div>

    <!-- Not crucial, but we put this under a CC By-SA 3.0 license. -->
        <!-- http://creativecommons.org/licenses/ -->
    <div class="row-fluid footer">
      <div class="span12">
        <p class="muted">This work is licensed under
          the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC
            By-SA 3.0
          </a>. Lots of credit goes to <a href="http://www.github.com/mbostock">Mike Bostock</a> for building the original map, zoom functionality and d3.js. You're a baller. </p>
      </div>
    </div>
  </div>
  <script type="text/javascript">
  $('#close').on('click', function () {
      zoomOut();
  });
  </script>
</body>

